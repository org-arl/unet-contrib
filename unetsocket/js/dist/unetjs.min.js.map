{"version":3,"file":"unetjs.min.js","sources":["../../../../fjage/gateways/js/dist/esm/fjage.js","../src/unetutils.js","../src/unetsocket.js"],"sourcesContent":["/* fjage.js v1.9.1-rc5 2021-07-07T04:07:53.061Z */\n\n/* global window self */\n\nconst isBrowser = typeof window !== 'undefined' && typeof window.document !== 'undefined';\n\n/* eslint-disable no-restricted-globals */\nconst isWebWorker = typeof self === 'object'\n  && self.constructor\n  && self.constructor.name === 'DedicatedWorkerGlobalScope';\n/* eslint-enable no-restricted-globals */\n\nconst isNode = typeof process !== 'undefined'\n  && process.versions != null\n  && process.versions.node != null;\n\n/**\n * @see https://github.com/jsdom/jsdom/releases/tag/12.0.0\n * @see https://github.com/jsdom/jsdom/issues/1537\n */\n/* eslint-disable no-undef */\nconst isJsDom = () => (typeof window !== 'undefined' && window.name === 'nodejs')\n  || navigator.userAgent.includes('Node.js')\n  || navigator.userAgent.includes('jsdom');\n\nconst SOCKET_OPEN = 'open';\nconst SOCKET_OPENING = 'opening';\n\nvar createConnection;\n\n/**\n * @class\n * @ignore\n */\nclass TCPconnector {\n\n  /**\n    * Create an TCPConnector to connect to a fjage master over TCP\n    * @param {Object} opts\n    * @param {String} [opts.hostname='localhost'] - ip address/hostname of the master container to connect to\n    * @param {number} opts.port - port number of the master container to connect to\n    */\n  constructor(opts = {}) {\n    this.url = new URL('tcp://localhost');\n    let host = opts.hostname || 'localhost';\n    let port = opts.port || -1;\n    this.url.hostname = opts.hostname;\n    this.url.port = opts.port;\n    this._buf = '';\n    this.pendingOnOpen = [];              // list of callbacks make as soon as gateway is open\n    this.connListeners = [];              // external listeners wanting to listen connection events\n    this._sockInit(host, port);\n  }\n\n\n  _sendConnEvent(val) {\n    this.connListeners.forEach(l => {\n      l && {}.toString.call(l) === '[object Function]' && l(val);\n    });\n  }\n\n  _sockInit(host, port){\n    if (!createConnection){\n      try {\n        import('net').then(module => {\n          createConnection = module.createConnection;\n          this._sockSetup(host, port);\n        });\n      }catch(error){\n        if(this.debug) console.log('Unable to import net module');\n      }\n    }else {\n      this._sockSetup(host, port);\n    }  \n  }\n\n  _sockSetup(host, port){\n    if(!createConnection) return;\n    try{\n      this.sock = createConnection({ 'host': host, 'port': port });\n      this.sock.setEncoding('utf8');\n      this.sock.on('connect', this._onSockOpen.bind(this));\n      this.sock.on('error', this._sockReconnect.bind(this));\n      this.sock.on('close', () => {this._sendConnEvent(false);});\n      this.sock.send = data => {this.sock.write(data);};\n    } catch (error) {\n      if(this.debug) console.log('Connection failed to ', this.sock.host + ':' + this.sock.port);\n      return;\n    }\n  }\n\n  _sockReconnect(){\n    if (this._firstConn || !this.keepAlive || this.sock.readyState == SOCKET_OPENING || this.sock.readyState == SOCKET_OPEN) return;\n    if (this._firstReConn) this._sendConnEvent(false);\n    this._firstReConn = false;\n    if(this.debug) console.log('Reconnecting to ', this.sock.remoteAddress + ':' + this.sock.remotePort);\n    setTimeout(() => {\n      this.pendingOnOpen = [];\n      this._sockSetup(this.sock.url);\n    }, this._reconnectTime);\n  }\n\n  _onSockOpen() {\n    this._sendConnEvent(true);\n    this.sock.on('close', this._sockReconnect.bind(this));\n    this.sock.on('data', this._processSockData.bind(this));\n    this.pendingOnOpen.forEach(cb => cb());\n    this.pendingOnOpen.length = 0;\n    this._buf = '';\n  }\n\n  _processSockData(s){\n    this._buf += s;\n    var lines = this._buf.split('\\n');\n    lines.forEach((l, idx) => {\n      if (idx < lines.length-1){\n        if (l && this._onSockRx) this._onSockRx.call(this,l);\n      } else {\n        this._buf = l;\n      }\n    });\n  }\n\n  toString(){\n    let s = '';\n    s += 'TCPConnector [' + this.sock ? this.sock.remoteAddress.toString() + ':' + this.sock.remotePort.toString() : '' + ']';\n    return s;\n  }\n\n  /**\n   * Write a string to the connector\n   * @param {string} s - string to be written out of the connector to the master\n   * @return {boolean} - true if connect was able to write or queue the string to the underlying socket\n   */\n  write(s){\n    if (!this.sock || this.sock.readyState == SOCKET_OPENING){\n      this.pendingOnOpen.push(() => {\n        this.sock.send(s+'\\n');\n      });\n      return true;\n    } else if (this.sock.readyState == SOCKET_OPEN) {\n      this.sock.send(s+'\\n');\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Set a callback for receiving incoming strings from the connector\n   * @param {TCPConnector~ReadCallback} cb - callback that is called when the connector gets a string\n   */\n  setReadCallback(cb){\n    if (cb && {}.toString.call(cb) === '[object Function]') this._onSockRx = cb;\n  }\n\n  /**\n   * @callback TCPConnector~ReadCallback\n   * @ignore\n   * @param {string} s - incoming message string\n   */\n  \n  /**\n   * Add listener for connection events\n   * @param {function} listener - a listener callback that is called when the connection is opened/closed\n   */\n  addConnectionListener(listener){\n    this.connListeners.push(listener);\n  }\n\n  /**\n   * Remove listener for connection events\n   * @param {function} listener - remove the listener for connection\n   * @return {boolean} - true if the listner was removed successfully\n   */\n  removeConnectionListener(listener) {\n    let ndx = this.connListeners.indexOf(listener);\n    if (ndx >= 0) {\n      this.connListeners.splice(ndx, 1);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Close the connector\n   */\n  close(){\n    if (!this.sock) return;\n    if (this.sock.readyState == SOCKET_OPENING) {\n      this.pendingOnOpen.push(() => {\n        this.sock.send('{\"alive\": false}\\n');\n        this.sock.onclose = null;\n        this.sock.destroy();\n      });\n    } else if (this.sock.readyState == SOCKET_OPEN) {\n      this.sock.send('{\"alive\": false}\\n');\n      this.sock.onclose = null;\n      this.sock.destroy();\n    }\n  }\n}\n\nconst DEFAULT_RECONNECT_TIME = 5000;       // ms, delay between retries to connect to the server.\n\n/**\n * @class\n * @ignore\n */\nclass WSConnector {\n\n  /**\n   * Create an WSConnector to connect to a fjage master over WebSockets\n   * @param {Object} opts\n   * @param {string} opts.hostname - hostname/ip address of the master container to connect to\n   * @param {number} opts.port - port number of the master container to connect to\n   * @param {string} opts.pathname - path of the master container to connect to\n   * @param {boolean} opts.keepAlive - try to reconnect if the connection is lost\n   * @param {number} [opts.reconnectTime=5000] - time before reconnection is attempted after an error\n   */\n  constructor(opts = {}) {\n    this.url = new URL('ws://localhost');\n    this.url.hostname = opts.hostname;      \n    this.url.port = opts.port;\n    this.url.pathname = opts.pathname;\n    this._reconnectTime = opts.reconnectTime || DEFAULT_RECONNECT_TIME;\n    this._keepAlive = opts.keepAlive;\n    this.debug = opts.debug || false;      // debug info to be logged to console?\n    this._firstConn = true;               // if the Gateway has managed to connect to a server before\n    this._firstReConn = true;             // if the Gateway has attempted to reconnect to a server before\n    this.pendingOnOpen = [];              // list of callbacks make as soon as gateway is open\n    this.connListeners = [];              // external listeners wanting to listen connection events\n    this._websockSetup(this.url);\n  }\n\n  _sendConnEvent(val) {\n    this.connListeners.forEach(l => {\n      l && {}.toString.call(l) === '[object Function]' && l(val);\n    });\n  }\n\n  _websockSetup(url){\n    try {\n      this.sock = new WebSocket(url);\n      this.sock.onerror = this._websockReconnect.bind(this);\n      this.sock.onopen = this._onWebsockOpen.bind(this);\n      this.sock.onclose = () => {this._sendConnEvent(false);};\n    } catch (error) {\n      if(this.debug) console.log('Connection failed to ', url);\n      return;\n    }\n  }\n\n  _websockReconnect(){\n    if (this._firstConn || !this._keepAlive || this.sock.readyState == this.sock.CONNECTING || this.sock.readyState == this.sock.OPEN) return;\n    if (this._firstReConn) this._sendConnEvent(false);\n    this._firstReConn = false;\n    if(this.debug) console.log('Reconnecting to ', this.sock.url);\n    setTimeout(() => {\n      this.pendingOnOpen = [];\n      this._websockSetup(this.sock.url);\n    }, this._reconnectTime);\n  }\n\n  _onWebsockOpen() {\n    if(this.debug) console.log('Connected to ', this.sock.url);\n    this._sendConnEvent(true);\n    this.sock.onclose = this._websockReconnect.bind(this);\n    this.sock.onmessage = event => { if (this._onWebsockRx) this._onWebsockRx.call(this,event.data); };\n    this._firstConn = false;\n    this._firstReConn = true;\n    this.pendingOnOpen.forEach(cb => cb());\n    this.pendingOnOpen.length = 0;\n  }\n\n  toString(){\n    let s = '';\n    s += 'WSConnector [' + this.sock ? this.sock.url.toString() : '' + ']';\n    return s;\n  }\n\n  /**\n   * Write a string to the connector\n   * @param {string} s - string to be written out of the connector to the master\n   */\n  write(s){\n    if (!this.sock || this.sock.readyState == this.sock.CONNECTING){\n      this.pendingOnOpen.push(() => {\n        this.sock.send(s+'\\n');\n      });\n      return true;\n    } else if (this.sock.readyState == this.sock.OPEN) {\n      this.sock.send(s+'\\n');\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Set a callback for receiving incoming strings from the connector\n   * @param {WSConnector~ReadCallback} cb - callback that is called when the connector gets a string\n   * @ignore\n   */\n  setReadCallback(cb){\n    if (cb && {}.toString.call(cb) === '[object Function]') this._onWebsockRx = cb;\n  }\n\n  /**\n   * @callback WSConnector~ReadCallback\n   * @ignore\n   * @param {string} s - incoming message string\n   */\n  \n  /**\n   * Add listener for connection events\n   * @param {function} listener - a listener callback that is called when the connection is opened/closed\n   */\n  addConnectionListener(listener){\n    this.connListeners.push(listener);\n  }\n\n  /**\n   * Remove listener for connection events\n   * @param {function} listener - remove the listener for connection\n   * @return {boolean} - true if the listner was removed successfully\n   */\n  removeConnectionListener(listener) {\n    let ndx = this.connListeners.indexOf(listener);\n    if (ndx >= 0) {\n      this.connListeners.splice(ndx, 1);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Close the connector\n   */\n  close(){\n    if (!this.sock) return;\n    if (this.sock.readyState == this.sock.CONNECTING) {\n      this.pendingOnOpen.push(() => {\n        this.sock.send('{\"alive\": false}\\n');\n        this.sock.onclose = null;\n        this.sock.close();\n      });\n    } else if (this.sock.readyState == this.sock.OPEN) {\n      this.sock.send('{\"alive\": false}\\n');\n      this.sock.onclose = null;\n      this.sock.close();\n    }\n  }\n}\n\n/* global global Buffer */\n\nconst DEFAULT_QUEUE_SIZE = 128;        // max number of old unreceived messages to store\n\n/**\n * An action represented by a message. The performative actions are a subset of the\n * FIPA ACL recommendations for interagent communication.\n * @typedef {Object} Performative\n */\nconst Performative = {\n  REQUEST: 'REQUEST',               // Request an action to be performed\n  AGREE: 'AGREE',                   // Agree to performing the requested action\n  REFUSE: 'REFUSE',                 // Refuse to perform the requested action\n  FAILURE: 'FAILURE',               // Notification of failure to perform a requested or agreed action\n  INFORM: 'INFORM',                 // Notification of an event\n  CONFIRM: 'CONFIRM',               // Confirm that the answer to a query is true\n  DISCONFIRM: 'DISCONFIRM',         // Confirm that the answer to a query is false\n  QUERY_IF: 'QUERY_IF',             // Query if some statement is true or false\n  NOT_UNDERSTOOD: 'NOT_UNDERSTOOD', // Notification that a message was not understood\n  CFP: 'CFP',                       // Call for proposal\n  PROPOSE: 'PROPOSE',               // Response for CFP\n  CANCEL: 'CANCEL'                  // Cancel pending request\n};\n\n/**\n * An identifier for an agent or a topic.\n * @class\n * @param {string} name - name of the agent\n * @param {boolean} topic - name of topic\n * @param {Gateway} owner - Gateway owner for this AgentID\n */\nclass AgentID {\n\n\n  constructor(name, topic, owner) {\n    this.name = name;\n    this.topic = topic;\n    this.owner = owner;\n  }\n\n  /**\n   * Gets the name of the agent or topic.\n   *\n   * @returns {string} - name of agent or topic\n   */\n  getName() {\n    return this.name;\n  }\n\n  /**\n   * Returns true if the agent id represents a topic.\n   *\n   * @returns {boolean} - true if the agent id represents a topic, false if it represents an agent\n   */\n  isTopic() {\n    return this.topic;\n  }\n\n  /**\n   * Sends a message to the agent represented by this id.\n   *\n   * @param {string} msg - message to send\n   * @returns {void}\n   */\n  send(msg) {\n    msg.recipient = this.toJSON();\n    this.owner.send(msg);\n  }\n\n  /**\n   * Sends a request to the agent represented by this id and waits for a reponse.\n   *\n   * @param {Message} msg - request to send\n   * @param {number} [timeout=1000] - timeout in milliseconds\n   * @returns {Promise<Message>} - response\n   */\n  async request(msg, timeout=1000) {\n    msg.recipient = this.toJSON();\n    return this.owner.request(msg, timeout);\n  }\n\n  /**\n   * Gets a string representation of the agent id.\n   *\n   * @returns {string} - string representation of the agent id\n   */\n  toString() {\n    return this.toJSON() + ((this.owner && this.owner.connector) ? ` on ${this.owner.connector.url}` : '');\n  }\n\n  /**\n   * Gets a JSON string representation of the agent id.\n   *\n   * @returns {string} - JSON string representation of the agent id\n   */\n  toJSON() {\n    return (this.topic ? '#' : '') + this.name;\n  }\n\n  /**\n   * Sets parameter(s) on the Agent referred to by this AgentID.\n   *\n   * @param {(string|string[])} params - parameters name(s) to be set\n   * @param {(Object|Object[])} values - parameters value(s) to be set\n   * @param {number} [index=-1] - index of parameter(s) to be set\n   * @param {number} [timeout=5000] - timeout for the response\n   * @returns {Promise<(Object|Object[])>} - a promise which returns the new value(s) of the parameters\n   */\n  async set (params, values, index=-1, timeout=5000) {\n    if (!params) return null;\n    let msg = new ParameterReq();\n    msg.recipient = this.name;\n    if (Array.isArray(params)){\n      msg.requests = params.map((p, i) => {\n        return {\n          'param': p,\n          'value': values[i]\n        };\n      });\n    } else {\n      msg.param = params;\n      msg.value = values;\n    }\n    msg.index = Number.isInteger(index) ? index : -1;\n    const rsp = await this.owner.request(msg, timeout);\n    var ret = Array.isArray(params) ? new Array(params.length).fill(null) : null;\n    if (!rsp || rsp.perf != Performative.INFORM || !rsp.param) return ret;\n    if (Array.isArray(params)) {\n      if (!rsp.values) rsp.values = {};\n      if (rsp.param) rsp.values[rsp.param] = rsp.value;\n      const rvals = Object.keys(rsp.values);\n      return params.map( p => {\n        let f = rvals.find(rv => rv.endsWith(p));\n        return f ? rsp.values[f] : null;\n      });\n    } else {\n      return rsp.value;\n    }\n  }\n\n\n  /**\n   * Gets parameter(s) on the Agent referred to by this AgentID.\n   *\n   * @param {(?string|?string[])} params - parameters name(s) to be get, null implies get value of all parameters on the Agent\n   * @param {number} [index=-1] - index of parameter(s) to be get\n   * @param {number} [timeout=5000] - timeout for the response\n   * @returns {Promise<(?Object|?Object[])>} - a promise which returns the value(s) of the parameters\n   */\n  async get(params, index=-1, timeout=5000) {\n    let msg = new ParameterReq();\n    msg.recipient = this.name;\n    if (params){\n      if (Array.isArray(params)) msg.requests = params.map(p => {return {'param': p};});\n      else msg.param = params;\n    }\n    msg.index = Number.isInteger(index) ? index : -1;\n    const rsp = await this.owner.request(msg, timeout);\n    var ret = Array.isArray(params) ? new Array(params.length).fill(null) : null;\n    if (!rsp || rsp.perf != Performative.INFORM || (params && (!rsp.param))) return ret;\n    // Request for listing of all parameters.\n    if (!params) {\n      if (!rsp.values) rsp.values = {};\n      if (rsp.param) rsp.values[rsp.param] = rsp.value;\n      return rsp.values;\n    } else if (Array.isArray(params)) {\n      if (!rsp.values) rsp.values = {};\n      if (rsp.param) rsp.values[rsp.param] = rsp.value;\n      const rvals = Object.keys(rsp.values);\n      return params.map(p => {\n        let f = rvals.find(rv => rv.endsWith(p));\n        return f ? rsp.values[f] : null;\n      });\n    } else {\n      return rsp.value;\n    }\n  }\n}\n\n/**\n * Base class for messages transmitted by one agent to another. Creates an empty message.\n * @class\n * @param {Message} inReplyTo - message to which this response corresponds to\n * @param {Performative} - performative\n */\nclass Message {\n\n  constructor(inReplyTo={msgID:null, sender:null}, perf='') {\n    this.__clazz__ = 'org.arl.fjage.Message';\n    this.msgID = _guid(8);\n    this.sender = null;\n    this.recipient = inReplyTo.sender;\n    this.perf = perf;\n    this.inReplyTo = inReplyTo.msgID || null;\n  }\n\n  /**\n   * Gets a string representation of the message.\n   *\n   * @returns {string} - string representation\n   */\n  toString() {\n    let s = '';\n    let suffix = '';\n    if (!this.__clazz__) return '';\n    let clazz = this.__clazz__;\n    clazz = clazz.replace(/^.*\\./, '');\n    let perf = this.perf;\n    for (var k in this) {\n      if (k.startsWith('__')) continue;\n      if (k == 'sender') continue;\n      if (k == 'recipient') continue;\n      if (k == 'msgID') continue;\n      if (k == 'perf') continue;\n      if (k == 'inReplyTo') continue;\n      if (typeof this[k] == 'object') {\n        suffix = ' ...';\n        continue;\n      }\n      s += ' ' + k + ':' + this[k];\n    }\n    s += suffix;\n    return clazz+':'+perf+'['+s.replace(/^ /, '')+']';\n  }\n\n  // convert a message into a JSON string\n  // NOTE: we don't do any base64 encoding for TX as\n  //       we don't know what data type is intended\n  /** @private */\n  _serialize() {\n    let clazz = this.__clazz__ || 'org.arl.fjage.Message';\n    let data = JSON.stringify(this, (k,v) => {\n      if (k.startsWith('__')) return;\n      return v;\n    });\n    return '{ \"clazz\": \"'+clazz+'\", \"data\": '+data+' }';\n  }\n\n  // inflate a data dictionary into the message\n  /** @private */\n  _inflate(data) {\n    for (var key in data)\n      this[key] = data[key];\n  }\n\n  // convert a dictionary (usually from decoding JSON) into a message\n  /** @private */\n  static _deserialize(obj) {\n    if (typeof obj == 'string' || obj instanceof String) {\n      try {\n        obj = JSON.parse(obj);\n      }catch(e){\n        return null;\n      }\n    }\n    let qclazz = obj.clazz;\n    let clazz = qclazz.replace(/^.*\\./, '');\n    let rv = MessageClass[clazz] ? new MessageClass[clazz] : new Message();\n    rv.__clazz__ = qclazz;\n    rv._inflate(obj.data);\n    return rv;\n  }\n}\n\n/**\n * A message class that can convey generic messages represented by key-value pairs.\n * @class\n * @extends Message\n */\nclass GenericMessage extends Message {\n  /**\n   * Creates an empty generic message.\n   */\n  constructor() {\n    super();\n    this.__clazz__ = 'org.arl.fjage.GenericMessage';\n  }\n}\n\n/**\n * A gateway for connecting to a fjage master container. The new version of the constructor\n * uses an options object instead of individual parameters. The old version with \n * \n * \n * @class\n * @param {Object} opts\n * @param {string} [opts.hostname=\"localhost\"] - hostname/ip address of the master container to connect to\n * @param {number} [opts.port=1100]          - port number of the master container to connect to\n * @param {string} [opts.pathname=\"\"]        - path of the master container to connect to (for WebSockets)\n * @param {string} [opts.keepAlive=true]     - try to reconnect if the connection is lost\n * @param {number} [opts.queueSize=128]      - size of the queue of received messages that haven't been consumed yet\n * @param {number} [opts.timeout=1000]       - timeout for fjage level messages in ms\n * @param {string} [hostname=\"localhost\"]    - <strike>Deprecated : hostname/ip address of the master container to connect to</strike>\n * @param {number} [port=]                   - <strike>Deprecated : port number of the master container to connect to</strike>\n * @param {string} [pathname==\"/ws/\"]        - <strike>Deprecated : path of the master container to connect to (for WebSockets)</strike>\n * @param {number} [timeout=1000]            - <strike>Deprecated : timeout for fjage level messages in ms</strike>\n */\nclass Gateway {\n\n  constructor(opts = {}, port, pathname='/ws/', timeout=1000) {\n    // Support for deprecated constructor\n    if (typeof opts === 'string' || opts instanceof String){\n      opts = {\n        'hostname': opts,\n        'port' : port || gObj.location.port, \n        'pathname' : pathname,\n        'timeout' : timeout\n      };\n      console.warn('Deprecated use of Gateway constructor');\n    }\n    opts = Object.assign({}, GATEWAY_DEFAULTS, opts);\n    var url = DEFAULT_URL;\n    url.hostname = opts.hostname;\n    url.port = opts.port;\n    url.pathname = opts.pathname;\n    let existing = this._getGWCache(url);\n    if (existing) return existing;\n    this._timeout = opts.timeout;         // timeout for fjage level messages (agentForService etc)\n    this._keepAlive = opts.keepAlive;     // reconnect if connection gets closed/errored\n    this._queueSize = opts.queueSize;      // size of queue\n    this.pending = {};                    // msgid to callback mapping for pending requests to server\n    this.subscriptions = {};              // hashset for all topics that are subscribed\n    this.listener = {};                   // set of callbacks that want to listen to incoming messages\n    this.eventListeners = {};             // external listeners wanting to listen internal events\n    this.queue = [];                      // incoming message queue\n    this.debug = false;                   // debug info to be logged to console?\n    this.aid = new AgentID(isBrowser ? 'WebGW-' : 'NodeGW-'+_guid(4));         // gateway agent name\n    this.connector = this._createConnector(url);\n    this._addGWCache(this);\n  }\n\n  /** @private */\n  _sendEvent(type, val) {\n    if (Array.isArray(this.eventListeners[type])) {\n      this.eventListeners[type].forEach(l => {\n        l && {}.toString.call(l) === '[object Function]' && l(val);\n      });\n    }\n  }\n\n  /** @private */\n  _onMsgRx(data) {\n    var obj;\n    if (this.debug) console.log('< '+data);\n    this._sendEvent('rx', data);\n    try {\n      obj = JSON.parse(data, _decodeBase64);\n    }catch(e){\n      return;\n    }\n    this._sendEvent('rxp', obj);\n    if ('id' in obj && obj.id in this.pending) {\n      // response to a pending request to master\n      this.pending[obj.id](obj);\n      delete this.pending[obj.id];\n    } else if (obj.action == 'send') {\n      // incoming message from master\n      let msg = Message._deserialize(obj.message);\n      if (!msg) return;\n      this._sendEvent('rxmsg', msg);\n      if ((msg.recipient == this.aid.toJSON() )|| this.subscriptions[msg.recipient]) {\n        var consumed = false;\n        if (Array.isArray(this.eventListeners['message'])){\n          for (var i = 0; i < this.eventListeners['message'].length; i++) {\n            if (this.eventListeners['message'][i](msg)) {\n              consumed = true;\n              break;\n            }\n          }\n        }\n        // iterate over internal callbacks, until one consumes the message\n        for (var key in this.listener){\n          // callback returns true if it has consumed the message\n          if (this.listener[key](msg)) {\n            consumed = true;\n            break;\n          }\n        }\n        if(!consumed) {\n          if (this.queue.length >= this._queueSize) this.queue.shift();\n          this.queue.push(msg);\n        }\n      }\n    } else {\n      // respond to standard requests that every container must\n      let rsp = { id: obj.id, inResponseTo: obj.action };\n      switch (obj.action) {\n      case 'agents':\n        rsp.agentIDs = [this.aid.getName()];\n        break;\n      case 'containsAgent':\n        rsp.answer = (obj.agentID == this.aid.getName());\n        break;\n      case 'services':\n        rsp.services = [];\n        break;\n      case 'agentForService':\n        rsp.agentID = '';\n        break;\n      case 'agentsForService':\n        rsp.agentIDs = [];\n        break;\n      default:\n        rsp = undefined;\n      }\n      if (rsp) this._msgTx(rsp);\n    }\n  }\n\n  /** @private */\n  _msgTx(s) {\n    if (typeof s != 'string' && !(s instanceof String)) s = JSON.stringify(s);\n    if(this.debug) console.log('> '+s);\n    this._sendEvent('tx', s);\n    return this.connector.write(s);\n  }\n\n  /** @private */\n  _msgTxRx(rq) {\n    rq.id = _guid(8);\n    return new Promise(resolve => {\n      let timer = setTimeout(() => {\n        delete this.pending[rq.id];\n        if (this.debug) console.log('Receive Timeout : ' + rq);\n        resolve();\n      }, 8*this._timeout);\n      this.pending[rq.id] = rsp => {\n        clearTimeout(timer);\n        resolve(rsp);\n      };\n      if (!this._msgTx.call(this,rq)) {\n        clearTimeout(timer);\n        delete this.pending[rq.id];\n        if (this.debug) console.log('Transmit Timeout : ' + rq);\n        resolve();\n      }\n    });\n  }\n\n  /** @private */\n  _createConnector(url){\n    let conn;\n    if (url.protocol.startsWith('ws')){\n      conn =  new WSConnector({\n        'hostname':url.hostname,\n        'port':url.port,\n        'pathname':url.pathname,\n        'keepAlive': this._keepAlive\n      });\n    }else if (url.protocol.startsWith('tcp')){\n      conn = new TCPconnector({\n        'hostname':url.hostname,\n        'port':url.port,\n        'keepAlive': this._keepAlive\n      });\n    } else return null;\n    conn.setReadCallback(this._onMsgRx.bind(this));\n    conn.addConnectionListener(state => {\n      if (state == true){\n        this.flush();\n        this.connector.write('{\"alive\": true}');\n        this._update_watch();\n      }\n    });\n    return conn;\n  }\n\n  /** @private */\n  _matchMessage(filter, msg){\n    if (typeof filter == 'string' || filter instanceof String) {\n      return 'inReplyTo' in msg && msg.inReplyTo == filter;\n    } else if (Object.prototype.hasOwnProperty.call(filter, 'msgID')) {\n      return 'inReplyTo' in msg && msg.inReplyTo == filter.msgID;\n    } else if (filter.__proto__.name == 'Message') {\n      return filter.__clazz__ == msg.__clazz__;\n    } else if (typeof filter == 'function') {\n      return filter(msg);\n    } else {\n      return msg instanceof filter;\n    }\n  }\n\n  /** @private */\n  _getMessageFromQueue(filter) {\n    if (!this.queue.length) return;\n    if (!filter) return this.queue.shift();\n\n    let matchedMsg = this.queue.find( msg => this._matchMessage(filter, msg));\n    if (matchedMsg) this.queue.splice(this.queue.indexOf(matchedMsg), 1);\n\n    return matchedMsg;\n  }\n\n  /** @private */\n  _getGWCache(url){\n    if (!gObj.fjage || !gObj.fjage.gateways) return null;\n    var f = gObj.fjage.gateways.filter(g => g.connector.url.toString() == url.toString());\n    if (f.length ) return f[0];\n    return null;\n  }\n  \n  /** @private */\n  _addGWCache(gw){\n    if (!gObj.fjage || !gObj.fjage.gateways) return;\n    gObj.fjage.gateways.push(gw);\n  }\n  \n  /** @private */\n  _removeGWCache(gw){\n    if (!gObj.fjage || !gObj.fjage.gateways) return;\n    var index = gObj.fjage.gateways.indexOf(gw);\n    if (index != null) gObj.fjage.gateways.splice(index,1);\n  }\n\n  /** @private */\n  _update_watch() {\n    // FIXME : Turning off wantsMessagesFor in fjagejs for now as it breaks multiple browser\n    // windows connecting to the same master container.\n    //\n    // let watch = Object.keys(this.subscriptions);\n    // watch.push(this.aid.getName());\n    // let rq = { action: 'wantsMessagesFor', agentIDs: watch };\n    // this._msgTx(rq);\n  }\n\n  /**\n   * Add an event listener to listen to various events happening on this Gateway\n   *\n   * @param {string} type - type of event to be listened to\n   * @param {function} listener - new callback/function to be called when the event happens\n   * @returns {void}\n   */\n  addEventListener(type, listener) {\n    if (!Array.isArray(this.eventListeners[type])){\n      this.eventListeners[type] = [];\n    }\n    this.eventListeners[type].push(listener);\n  }\n\n  /**\n   * Remove an event listener.\n   *\n   * @param {string} type - type of event the listener was for\n   * @param {function} listener - callback/function which was to be called when the event happens\n   * @returns {void}\n   */\n  removeEventListener(type, listener) {\n    if (!this.eventListeners[type]) return;\n    let ndx = this.eventListeners[type].indexOf(listener);\n    if (ndx >= 0) this.eventListeners[type].splice(ndx, 1);\n  }\n\n  /**\n   * Add a new listener to listen to all {Message}s sent to this Gateway\n   *\n   * @param {function} listener - new callback/function to be called when a {Message} is received\n   * @returns {void}\n   */\n  addMessageListener(listener) {\n    this.addEventListener('message',listener);\n  }\n\n  /**\n   * Remove a message listener.\n   *\n   * @param {function} listener - removes a previously registered listener/callback\n   * @returns {void}\n   */\n  removeMessageListener(listener) {\n    this.removeEventListener('message', listener);\n  }\n\n  /**\n   * Add a new listener to get notified when the connection to master is created and terminated.\n   *\n   * @param {function} listener - new callback/function to be called connection to master is created and terminated\n   * @returns {void}\n   */\n  addConnListener(listener) {\n    this.addEventListener('conn', listener);\n  }\n\n  /**\n   * Remove a connection listener.\n   *\n   * @param {function} listener - removes a previously registered listener/callback\n   * @returns {void}\n   */\n  removeConnListener(listener) {\n    this.removeEventListener('conn', listener);\n  }\n\n  /**\n   * Gets the agent ID associated with the gateway.\n   *\n   * @returns {string} - agent ID\n   */\n  getAgentID() {\n    return this.aid;\n  }\n\n  /**\n   * Get an AgentID for a given agent name.\n   *\n   * @param {string} name - name of agent\n   * @returns {AgentID} - AgentID for the given name\n   */\n  agent(name) {\n    return new AgentID(name, false, this);\n  }\n\n  /**\n   * Returns an object representing the named topic.\n   *\n   * @param {string|AgentID} topic - name of the topic or AgentID\n   * @param {string} topic2 - name of the topic if the topic param is an AgentID\n   * @returns {AgentID} - object representing the topic\n   */\n  topic(topic, topic2) {\n    if (typeof topic == 'string' || topic instanceof String) return new AgentID(topic, true, this);\n    if (topic instanceof AgentID) {\n      if (topic.isTopic()) return topic;\n      return new AgentID(topic.getName()+(topic2 ? '__' + topic2 : '')+'__ntf', true, this);\n    }\n  }\n\n  /**\n   * Subscribes the gateway to receive all messages sent to the given topic.\n   *\n   * @param {AgentID} topic - the topic to subscribe to\n   * @returns {boolean} - true if the subscription is successful, false otherwise\n   */\n  subscribe(topic) {\n    if (!topic.isTopic()) topic = new AgentID(topic.getName() + '__ntf', true, this);\n    this.subscriptions[topic.toJSON()] = true;\n    this._update_watch();\n  }\n\n  /**\n   * Unsubscribes the gateway from a given topic.\n   *\n   * @param {AgentID} topic - the topic to unsubscribe\n   * @returns {void}\n   */\n  unsubscribe(topic) {\n    if (!topic.isTopic()) topic = new AgentID(topic.getName() + '__ntf', true, this);\n    delete this.subscriptions[topic.toJSON()];\n    this._update_watch();\n  }\n\n  /**\n   * Finds an agent that provides a named service. If multiple agents are registered\n   * to provide a given service, any of the agents' id may be returned.\n   *\n   * @param {string} service - the named service of interest\n   * @returns {Promise<?AgentID>} - a promise which returns an agent id for an agent that provides the service when resolved\n   */\n  async agentForService(service) {\n    let rq = { action: 'agentForService', service: service };\n    let rsp = await this._msgTxRx(rq);\n    if (!rsp || !rsp.agentID) return;\n    return new AgentID(rsp.agentID, false, this);\n  }\n\n  /**\n   * Finds all agents that provides a named service.\n   *\n   * @param {string} service - the named service of interest\n   * @returns {Promise<?AgentID[]>} - a promise which returns an array of all agent ids that provides the service when resolved\n   */\n  async agentsForService(service) {\n    let rq = { action: 'agentsForService', service: service };\n    let rsp = await this._msgTxRx(rq);\n    let aids = [];\n    if (!rsp || !Array.isArray(rsp.agentIDs)) return aids;\n    for (var i = 0; i < rsp.agentIDs.length; i++)\n      aids.push(new AgentID(rsp.agentIDs[i], false, this));\n    return aids;\n  }\n\n  /**\n   * Sends a message to the recipient indicated in the message. The recipient\n   * may be an agent or a topic.\n   *\n   * @param {Message} msg - message to be sent\n   * @returns {boolean} - if sending was successful\n   */\n  send(msg) {\n    msg.sender = this.aid.toJSON();\n    if (msg.perf == '') {\n      if (msg.__clazz__.endsWith('Req')) msg.perf = Performative.REQUEST;\n      else msg.perf = Performative.INFORM;\n    }\n    this._sendEvent('txmsg', msg);\n    let rq = JSON.stringify({ action: 'send', relay: true, message: '###MSG###' });\n    rq = rq.replace('\"###MSG###\"', msg._serialize());\n    return !!this._msgTx(rq);\n  }\n\n  /**\n   * Flush the Gateway queue for all pending messages. This drops all the pending messages.\n   * @returns {void}\n   *\n   */\n  flush() {\n    this.queue.length = 0;\n  }\n\n  /**\n   * Sends a request and waits for a response. This method returns a {Promise} which resolves when a response \n   * is received or if no response is received after the timeout.\n   *\n   * @param {string} msg - message to send\n   * @param {number} [timeout=1000] - timeout in milliseconds\n   * @returns {Promise<?Message>} - a promise which resolves with the received response message, null on timeout\n   */\n  async request(msg, timeout=1000) {\n    this.send(msg);\n    return this.receive(msg, timeout);\n  }\n\n  /**\n   * Returns a response message received by the gateway. This method returns a {Promise} which resolves when \n   * a response is received or if no response is received after the timeout.\n   *\n   * @param {function} [filter=] - original message to which a response is expected, or a MessageClass of the type \n   * of message to match, or a closure to use to match against the message\n   * @param {number} [timeout=0] - timeout in milliseconds\n   * @returns {Promise<?Message>} - received response message, null on timeout\n   */\n  async receive(filter, timeout=0) {\n    return new Promise(resolve => {\n      let msg = this._getMessageFromQueue.call(this,filter);\n      if (msg) {\n        resolve(msg);\n        return;\n      }\n      if (timeout == 0) {\n        if (this.debug) console.log('Receive Timeout : ' + filter);\n        resolve();\n        return;\n      }\n      let lid = _guid(8);\n      let timer;\n      if (timeout > 0){\n        timer = setTimeout(() => {\n          delete this.listener[lid];\n          if (this.debug) console.log('Receive Timeout : ' + filter);\n          resolve();\n        }, timeout);\n      }\n      this.listener[lid] = msg => {\n        if (!this._matchMessage(filter, msg)) return false;\n        if(timer) clearTimeout(timer);\n        delete this.listener[lid];\n        resolve(msg);\n        return true;\n      };\n    });\n  }\n\n  /**\n   * Closes the gateway. The gateway functionality may not longer be accessed after\n   * this method is called.\n   * @returns {void}\n   */\n  close() {\n    this.connector.close();\n    this._removeGWCache(this);\n  }\n\n}\n\n/**\n * Services supported by fjage agents.\n */\nconst Services = {\n  SHELL : 'org.arl.fjage.shell.Services.SHELL'\n};\n\n/**\n * Creates a unqualified message class based on a fully qualified name.\n * @param {string} name - fully qualified name of the message class to be created\n * @param {class} [parent=Message] - class of the parent MessageClass to inherit from\n * @returns {function} - constructor for the unqualified message class\n * @example \n * const ParameterReq = MessageClass('org.arl.fjage.param.ParameterReq');\n * let pReq = new ParameterReq()\n */\nfunction MessageClass(name, parent=Message) {\n  let sname = name.replace(/^.*\\./, '');\n  if (MessageClass[sname]) return MessageClass[sname];\n  let cls = class extends parent {\n    constructor(params) {\n      super();\n      this.__clazz__ = name;\n      if (params){\n        const keys = Object.keys(params);\n        for (let k of keys) {\n          this[k] = params[k];\n        }\n      }\n    }\n  };\n  cls.__clazz__ = name;\n  MessageClass[sname] = cls;\n  return cls;\n}\n\n////// private utilities\n\n// generate random ID with length 4*len characters\n/** @private */\nfunction _guid(len) {\n  function s4() {\n    return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);\n  }\n  let s = s4();\n  for (var i = 0; i < len-1; i++)\n    s += s4();\n  return s;\n}\n  \n// convert from base 64 to array\n/** @private */\nfunction _b64toArray(base64, dtype, littleEndian=true) {\n  let s = gObj.atob(base64);\n  let len = s.length;\n  let bytes = new Uint8Array(len);\n  for (var i = 0; i < len; i++)\n    bytes[i] = s.charCodeAt(i);\n  let rv = [];\n  let view = new DataView(bytes.buffer);\n  switch (dtype) {\n  case '[B': // byte array\n    for (i = 0; i < len; i++)\n      rv.push(view.getUint8(i));\n    break;\n  case '[S': // short array\n    for (i = 0; i < len; i+=2)\n      rv.push(view.getInt16(i, littleEndian));\n    break;\n  case '[I': // integer array\n    for (i = 0; i < len; i+=4)\n      rv.push(view.getInt32(i, littleEndian));\n    break;\n  case '[J': // long array\n    for (i = 0; i < len; i+=8)\n      rv.push(view.getInt64(i, littleEndian));\n    break;\n  case '[F': // float array\n    for (i = 0; i < len; i+=4)\n      rv.push(view.getFloat32(i, littleEndian));\n    break;\n  case '[D': // double array\n    for (i = 0; i < len; i+=8)\n      rv.push(view.getFloat64(i, littleEndian));\n    break;\n  default:\n    return;\n  }\n  return rv;\n}\n\n// base 64 JSON decoder\n/** @private */\nfunction _decodeBase64(k, d) {\n  if (d === null) {\n    return null;\n  }\n  if (typeof d == 'object' && 'clazz' in d) {\n    let clazz = d.clazz;\n    if (clazz.startsWith('[') && clazz.length == 2 && 'data' in d) {\n      let x = _b64toArray(d.data, d.clazz);\n      if (x) d = x;\n    }\n  }\n  return d;\n}\n\n////// global\n\nconst GATEWAY_DEFAULTS = {};\nlet gObj = {};\nlet DEFAULT_URL;\nif (isBrowser || isWebWorker){\n  gObj = window;\n  Object.assign(GATEWAY_DEFAULTS, {\n    'hostname': gObj.location.hostname,\n    'port': gObj.location.port,\n    'pathname' : '/ws/',\n    'timeout': 1000,\n    'keepAlive' : true,\n    'queueSize': DEFAULT_QUEUE_SIZE\n  });\n  DEFAULT_URL = new URL('ws://localhost');\n  // Enable caching of Gateways\n  if (typeof gObj.fjage === 'undefined') gObj.fjage = {};\n  if (typeof gObj.fjage.gateways == 'undefined')gObj.fjage.gateways = [];\n} else if (isJsDom || isNode){\n  gObj = global;\n  Object.assign(GATEWAY_DEFAULTS, {\n    'hostname': 'localhost',\n    'port': '1100',\n    'pathname': '',\n    'timeout': 1000,\n    'keepAlive' : true,\n    'queueSize': DEFAULT_QUEUE_SIZE\n  });\n  DEFAULT_URL = new URL('tcp://localhost');\n  gObj.atob = a => Buffer.from(a, 'base64').toString('binary');\n}\n\nconst ParameterReq = MessageClass('org.arl.fjage.param.ParameterReq');\n\nexport { AgentID, Gateway, GenericMessage, Message, MessageClass, Performative, Services };\n","import {AgentID, MessageClass, Services} from 'fjage';\n\nconst DatagramReq = MessageClass('org.arl.unet.DatagramReq');\nconst DatagramNtf = MessageClass('org.arl.unet.DatagramNtf');\nconst BasebandSignal = MessageClass('org.arl.unet.bb.BasebandSignal');\n\nlet UnetServices = {\n  'NODE_INFO': 'org.arl.unet.Services.NODE_INFO',\n  'ADDRESS_RESOLUTION': 'org.arl.unet.Services.ADDRESS_RESOLUTION',\n  'DATAGRAM': 'org.arl.unet.Services.DATAGRAM',\n  'PHYSICAL': 'org.arl.unet.Services.PHYSICAL',\n  'RANGING': 'org.arl.unet.Services.RANGING',\n  'BASEBAND': 'org.arl.unet.Services.BASEBAND',\n  'LINK': 'org.arl.unet.Services.LINK',\n  'MAC': 'org.arl.unet.Services.MAC',\n  'ROUTING': 'org.arl.unet.Services.ROUTING',\n  'ROUTE_MAINTENANCE': 'org.arl.unet.Services.ROUTE_MAINTENANCE',\n  'TRANSPORT': 'org.arl.unet.Services.TRANSPORT',\n  'REMOTE': 'org.arl.unet.Services.REMOTE',\n  'STATE_MANAGER': 'org.arl.unet.Services.STATE_MANAGER',\n};\n\nObject.assign(Services, UnetServices);\n\n/**\n * Well-known protocol number assignments used in UnetStack\n * @typedef {Object.<string, number>} Protocol\n */\nlet Protocol = {\n  'DATA' : 0,               // Protocol number for user application data.\n  'RANGING' : 1,            // Protocol number for use by ranging agents.\n  'LINK' : 2,               // Protocol number for use by link agents.\n  'REMOTE' : 3,             // Protocol number for use by remote management agents.\n  'MAC' : 4,                // Protocol number for use by MAC protocol agents.\n  'ROUTING' : 5,            // Protocol number for use by routing agents.\n  'TRANSPORT' : 6,          // Protocol number for use by transport agents.\n  'ROUTE_MAINTENANCE' : 7,   // Protocol number for use by route maintenance agents.\n  'LINK2' : 8,              // Protocol number for use by secondary link agents.\n  'USER' : 32,              // Lowest protocol number allowable for user protocols.\n  'MAX' : 63,               // Largest protocol number allowable.\n};\n\n/**\n * Well-known protocol Messages used in UnetStack\n * @typedef {Object.<string, MessageClass>} UnetMessages\n */\nlet UnetMessages = {\n  // unet\n  'TestReportNtf'          : MessageClass('org.arl.unet.TestReportNtf'), \n  'AbnormalTerminationNtf' : MessageClass('org.arl.unet.AbnormalTerminationNtf'), \n  'CapabilityListRsp'      : MessageClass('org.arl.unet.CapabilityListRsp'), \n  'CapabilityReq'          : MessageClass('org.arl.unet.CapabilityReq'), \n  'ClearReq'               : MessageClass('org.arl.unet.ClearReq'), \n  'DatagramCancelReq'      : MessageClass('org.arl.unet.DatagramCancelReq'), \n  'DatagramDeliveryNtf'    : MessageClass('org.arl.unet.DatagramDeliveryNtf'), \n  'DatagramFailureNtf'     : MessageClass('org.arl.unet.DatagramFailureNtf'), \n  'DatagramNtf'            : MessageClass('org.arl.unet.DatagramNtf'), \n  'DatagramProgressNtf'    : MessageClass('org.arl.unet.DatagramProgressNtf'), \n  'DatagramReq'            : MessageClass('org.arl.unet.DatagramReq'), \n  'ParamChangeNtf'         : MessageClass('org.arl.unet.ParamChangeNtf'), \n  'RefuseRsp'              : MessageClass('org.arl.unet.RefuseRsp'), \n  'FailureNtf'             : MessageClass('org.arl.unet.FailureNtf'), \n\n  // net\n  'DatagramTraceReq'       : MessageClass('org.arl.unet.net.DatagramTraceReq'), \n  'RouteDiscoveryReq'      : MessageClass('org.arl.unet.net.RouteDiscoveryReq'), \n  'RouteTraceReq'          : MessageClass('org.arl.unet.net.RouteTraceReq'), \n  'RouteDiscoveryNtf'      : MessageClass('org.arl.unet.net.RouteDiscoveryNtf'), \n  'RouteTraceNtf'          : MessageClass('org.arl.unet.net.RouteTraceNtf'), \n\n  // phy\n  'FecDecodeReq'           : MessageClass('org.arl.unet.phy.FecDecodeReq'), \n  'RxJanusFrameNtf'        : MessageClass('org.arl.unet.phy.RxJanusFrameNtf'), \n  'TxJanusFrameReq'        : MessageClass('org.arl.unet.phy.TxJanusFrameReq'), \n  'BadFrameNtf'            : MessageClass('org.arl.unet.phy.BadFrameNtf'), \n  'BadRangeNtf'            : MessageClass('org.arl.unet.phy.BadRangeNtf'),\n  'ClearSyncReq'           : MessageClass('org.arl.unet.phy.ClearSyncReq'), \n  'CollisionNtf'           : MessageClass('org.arl.unet.phy.CollisionNtf'), \n  'RxFrameNtf'             : MessageClass('org.arl.unet.phy.RxFrameNtf', DatagramNtf), \n  'RxFrameStartNtf'        : MessageClass('org.arl.unet.phy.RxFrameStartNtf'), \n  'SyncInfoReq'            : MessageClass('org.arl.unet.phy.SyncInfoReq'), \n  'SyncInfoRsp'            : MessageClass('org.arl.unet.phy.SyncInfoRsp'), \n  'TxFrameNtf'             : MessageClass('org.arl.unet.phy.TxFrameNtf'), \n  'TxFrameReq'             : MessageClass('org.arl.unet.phy.TxFrameReq', DatagramReq), \n  'TxFrameStartNtf'        : MessageClass('org.arl.unet.phy.TxFrameStartNtf'), \n  'TxRawFrameReq'          : MessageClass('org.arl.unet.phy.TxRawFrameReq'), \n\n  // addr\n  'AddressAllocReq'        : MessageClass('org.arl.unet.addr.AddressAllocReq'), \n  'AddressAllocRsp'        : MessageClass('org.arl.unet.addr.AddressAllocRsp'), \n  'AddressResolutionReq'   : MessageClass('org.arl.unet.addr.AddressResolutionReq'), \n  'AddressResolutionRsp'   : MessageClass('org.arl.unet.addr.AddressResolutionRsp'), \n\n  // bb\n  'BasebandSignal'         : MessageClass('org.arl.unet.bb.BasebandSignal'), \n  'RecordBasebandSignalReq' : MessageClass('org.arl.unet.bb.RecordBasebandSignalReq'), \n  'RxBasebandSignalNtf'    : MessageClass('org.arl.unet.bb.RxBasebandSignalNtf', BasebandSignal), \n  'TxBasebandSignalReq'    : MessageClass('org.arl.unet.bb.TxBasebandSignalReq', BasebandSignal), \n\n  // link\n  'LinkStatusNtf'          : MessageClass('org.arl.unet.link.LinkStatusNtf'), \n\n  // localization\n  'RangeNtf'               : MessageClass('org.arl.unet.localization.RangeNtf'), \n  'RangeReq'               : MessageClass('org.arl.unet.localization.RangeReq'), \n  'BeaconReq'              : MessageClass('org.arl.unet.localization.BeaconReq'), \n  'RespondReq'             : MessageClass('org.arl.unet.localization.RespondReq'), \n  'InterrogationNtf'       : MessageClass('org.arl.unet.localization.InterrogationNtf'), \n\n\n  // mac\n  'ReservationAcceptReq'   : MessageClass('org.arl.unet.mac.ReservationAcceptReq'), \n  'ReservationCancelReq'   : MessageClass('org.arl.unet.mac.ReservationCancelReq'), \n  'ReservationReq'         : MessageClass('org.arl.unet.mac.ReservationReq'), \n  'ReservationRsp'         : MessageClass('org.arl.unet.mac.ReservationRsp'), \n  'ReservationStatusNtf'   : MessageClass('org.arl.unet.mac.ReservationStatusNtf'), \n  'RxAckNtf'               : MessageClass('org.arl.unet.mac.RxAckNtf'), \n  'TxAckReq'               : MessageClass('org.arl.unet.mac.TxAckReq'), \n\n\n  // remote\n  'RemoteExecReq'          : MessageClass('org.arl.unet.remote.RemoteExecReq'), \n  'RemoteFailureNtf'       : MessageClass('org.arl.unet.remote.RemoteFailureNtf'), \n  'RemoteFileGetReq'       : MessageClass('org.arl.unet.remote.RemoteFileGetReq'), \n  'RemoteFileNtf'          : MessageClass('org.arl.unet.remote.RemoteFileNtf'), \n  'RemoteFilePutReq'       : MessageClass('org.arl.unet.remote.RemoteFilePutReq'), \n  'RemoteSuccessNtf'       : MessageClass('org.arl.unet.remote.RemoteSuccessNtf'), \n  'RemoteTextNtf'          : MessageClass('org.arl.unet.remote.RemoteTextNtf'), \n  'RemoteTextReq'          : MessageClass('org.arl.unet.remote.RemoteTextReq'), \n\n  // scheduler\n  'AddScheduledSleepReq'   : MessageClass('org.arl.unet.scheduler.AddScheduledSleepReq'), \n  'GetSleepScheduleReq'    : MessageClass('org.arl.unet.scheduler.GetSleepScheduleReq'), \n  'RemoveScheduledSleepReq' : MessageClass('org.arl.unet.scheduler.RemoveScheduledSleepReq'), \n  'SleepScheduleRsp'       : MessageClass('org.arl.unet.scheduler.SleepScheduleRsp'), \n  'WakeFromSleepNtf'       : MessageClass('org.arl.unet.scheduler.WakeFromSleepNtf'), \n\n  // state\n  'ClearStateReq'          : MessageClass('org.arl.unet.state.ClearStateReq'), \n  'SaveStateReq'           : MessageClass('org.arl.unet.state.SaveStateReq')\n};\n\n/**\n * A message which requests the transmission of the datagram from the Unet\n * \n * @typedef {Message} DatagramReq\n * @property {number[]} data - data as an Array of bytes\n * @property {number} from - from/source node address\n * @property {number} to - to/destination node address\n * @property {number} protocol - protocol number to be used to send this Datagram\n * @property {boolean} reliability - true if Datagram should be reliable, false if unreliable\n * @property {number} ttl - time-to-live for the datagram. Time-to-live is advisory, and an agent may choose it ignore it\n */\n\n/**\n * Notification of received datagram message received by the Unet node.\n * \n * @typedef {Message} DatagramNtf\n * @property {number[]} data - data as an Array of bytes\n * @property {number} from - from/source node address\n * @property {number} to - to/destination node address\n * @property {number} protocol - protocol number to be used to send this Datagram\n * @property {number} ttl - time-to-live for the datagram. Time-to-live is advisory, and an agent may choose it ignore it\n */\n\n/**\n * An identifier for an agent or a topic.\n * @external AgentID\n * @see {@link https://org-arl.github.io/fjage/jsdoc/|fjge.js Documentation}\n */\n\n/**\n * Services supported by fjage agents.\n * @external Services\n * @see {@link https://org-arl.github.io/fjage/jsdoc/|fjge.js Documentation}\n */\n\n/**\n *  An action represented by a message.\n * @external Performative\n * @see {@link https://org-arl.github.io/fjage/jsdoc/|fjge.js Documentation}\n */\n\n/**\n * Function to creates a unqualified message class based on a fully qualified name.\n * @external MessageClass\n * @see {@link https://org-arl.github.io/fjage/jsdoc/|fjge.js Documentation}\n */\n\n/**\n * @external Gateway\n * @see {@link https://org-arl.github.io/fjage/jsdoc/|fjge.js Documentation}\n */\n\nexport {AgentID, Services, UnetMessages, Protocol};\n","import {Gateway, Performative} from 'fjage';\nimport {Services, UnetMessages, Protocol} from './unetutils';\n\nconst REQUEST_TIMEOUT = 1000;\n\nconst AddressResolutionReq = UnetMessages.AddressResolutionReq;\nconst DatagramReq = UnetMessages.DatagramReq;\nconst DatagramNtf = UnetMessages.DatagramNtf;\nconst RxFrameNtf = UnetMessages.RxFrameNtf;\n\n/**\n * Creates a new UnetSocket to connect to a running Unet instance. This constructor returns a \n * {@link Promise} instead of the constructed UnetSocket object. Use `await` or `.then()` to get \n * a reference to the UnetSocket object. Based on if this is run in a Browser or Node.js, \n * it will internally connect over WebSockets or TCP respectively.\n *\n * \n * @class UnetSocket\n * @param {string} [hostname] - hostname/ip address of the master container to connect to\n * @param {number} [port] - port number of the master container to connect to\n * @param {string} [path='']  - path of the master container to connect to (for WebSockets)\n * @returns {Promise<UnetSocket>} - Promise which resolves to the UnetSocket object being constructed\n * \n * @example\n * let socket = await new UnetSocket('localhost', 8081, '/ws/');\n */\nexport default class UnetSocket {\n\n  constructor(hostname, port, path='') { \n    return (async () => {\n      this.gw = new Gateway({\n        hostname : hostname,\n        port : port,\n        path : path\n      });\n      this.localProtocol = -1;\n      this.remoteAddress = -1;\n      this.remoteProtocol = Protocol.DATA;\n      this.timeout = 0;\n      this.provider = null;\n      const alist = await this.gw.agentsForService(Services.DATAGRAM);\n      alist.forEach(a => {this.gw.subscribe(this.gw.topic(a));});\n      return this;\n    })();\n  }\n\n  /**\n   * Closes the socket. The socket functionality may not longer be accessed after this method is called.\n   * @returns {void}\n   */\n  close() {\n    this.gw.close();\n    this.gw = null;\n  }\n\n  /**\n   * Checks if a socket is closed.\n   * @returns {boolean} - true if closed, false if open\n   */\n  isClosed() { \n    return this.gw == null;\n  }\n\n  /**\n   * Binds a socket to listen to a specific protocol datagrams.\n   * Protocol numbers between Protocol.DATA+1 to Protocol.USER-1 are reserved protocols \n   * and cannot be bound. Unbound sockets listen to all unreserved\n   * @param {Protocol} protocol - protocol number to listen for\n   * @returns {boolean} - true on success, false on failure\n   */\n  bind(protocol) {\n    if (protocol == Protocol.DATA || (protocol >= Protocol.USER && protocol <= Protocol.MAX)) {\n      this.localProtocol = protocol;\n      return true;\n    }\n    return false;\n  }\n  \n  /**\n   * Unbinds a socket so that it listens to all unreserved protocols. \n   * Protocol numbers between Protocol.DATA+1 to Protocol.USER-1 are considered reserved.\n   * @returns {void}\n   */\n  unbind() { this.localProtocol = -1;}\n\n  /**\n   * Checks if a socket is bound.\n   * @returns {boolean} - true if bound to a protocol, false if unbound\n   */\n  isBound() { return this.localProtocol >= 0;}\n\n  /**\n   * Sets the default destination address and destination protocol number for datagrams sent \n   * using this socket. The defaults can be overridden for specific send() calls. \n   * The default protcol number when a socket is opened is Protcol.DATA. \n   * The default node address is undefined. \n   * Protocol numbers between Protocol.DATA+1 to Protocol.USER-1 are considered reserved, \n   * and cannot be used for sending datagrams using the socket.\n   * \n   * @param {number} to - default destination node address\n   * @param {Protocol} protocol - default protocol number\n   * @returns {boolean} - true on success, false on failure\n   */\n  connect(to, protocol) {\n    if (to >= 0 && (protocol == Protocol.DATA || (protocol >= Protocol.USER && protocol <= Protocol.MAX))) {\n      this.remoteAddress = to;\n      this.remoteProtocol = protocol;\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Resets the default destination address to undefined, and the default protocol number \n   * to Protocol.DATA.\n   * @returns {void}\n   */\n  disconnect() { \n    this.remoteAddress = -1;\n    this.remoteProtocol = 0;\n  }\n\n  /**\n   * Checks if a socket is connected, i.e., has a default destination address and protocol number.\n   * @returns {boolean} - true if connected, false otherwise\n   */\n  isConnected() { return this.remoteAddress >= 0; }\n\n  /**\n   * Gets the local node address of the Unet node connected to.\n   * @returns {Promise<int>} - local node address, or -1 on error\n   */\n  async getLocalAddress() { \n    if (this.gw == null) return -1;\n    const nodeinfo = await this.gw.agentForService(Services.NODE_INFO);\n    if (nodeinfo == null) return -1;\n    const addr = await nodeinfo.get('address');\n    return addr != null ? addr : -1;\n  }\n\n  /**\n   * Gets the protocol number that the socket is bound to.\n   * @returns {number}} - protocol number if socket is bound, -1 otherwise\n   */\n  getLocalProtocol() { return this.localProtocol; }\n\n  /**\n   * Gets the default destination node address for a connected socket.\n   * @returns {number}} - default destination node address if connected, -1 otherwise\n   */\n  getRemoteAddress() { return this.remoteAddress; }\n\n  /**\n   * Gets the default transmission protocol number.\n   * @returns {number}} - default protocol number used to transmit a datagram\n   */\n  getRemoteProtocol() { return this.remoteProtocol; }\n\n  /**\n   * Sets the timeout for datagram reception. A timeout of 0 means the \n   * {@link UnetSocket#receive|receive method} will check any appropriate \n   * Datagram has already been received (and is cached) else return immediately.\n   * \n   * @param {number} ms - timeout in milliseconds\n   * @returns {void}\n   */\n  setTimeout(ms) { \n    if (ms < 0) ms = 0;\n    this.timeout = ms;\n  }\n\n  /**\n   * Gets the timeout for datagram reception.\n   * @returns {number} - timeout in milliseconds\n   */\n  getTimeout() { return this.timeout; }\n\n  /**\n   * Transmits a datagram to the specified node address using the specified protocol.\n   * Protocol numbers between Protocol.DATA+1 to Protocol.USER-1 are considered reserved,\n   * and cannot be used for sending datagrams using the socket.\n   * @param {number[]|DatagramReq} data - data to be sent over the socket as an Array of bytes or DatagramReq\n   * @param {number} to - destination node address\n   * @param {number} protocol - protocol number\n   * @returns {Promise<boolean>} - true if the Unet node agreed to send out the Datagram, false otherwise\n   */\n  async send(data, to=this.remoteAddress, protocol=this.remoteProtocol) {\n    if (to < 0 || this.gw == null) return false;\n    var req;\n    if (Array.isArray(data)){\n      req = new DatagramReq();\n      req.data = data;\n      req.to = to;\n      req.protocol = protocol;\n    } else if (data instanceof DatagramReq){\n      req = data;\n    } else {\n      return false;\n    }\n    let p = req.protocol;\n    if (p != Protocol.DATA && (p < Protocol.USER || p > Protocol.MAX)) return false;\n    if (req.recipient == null) {\n      if (this.provider == null) this.provider = await this.gw.agentForService(Services.TRANSPORT);\n      if (this.provider == null) this.provider = await this.gw.agentForService(Services.ROUTING);\n      if (this.provider == null) this.provider = await this.gw.agentForService(Services.LINK);\n      if (this.provider == null) this.provider = await this.gw.agentForService(Services.PHYSICAL);\n      if (this.provider == null) this.provider = await this.gw.agentForService(Services.DATAGRAM);\n      if (this.provider == null) return false;\n      req.recipient = this.provider;\n    }\n    const rsp = await this.gw.request(req, REQUEST_TIMEOUT);\n    return (rsp != null && rsp.perf == Performative.AGREE);\n  }\n\n  /**\n   * Receives a datagram sent to the local node and the bound protocol number. If the socket is unbound, \n   * then datagrams with all unreserved protocols are received. Any broadcast datagrams are also received.\n   * \n   * @returns {Promise<?DatagramNtf>} - datagram received by the socket\n   */\n  async receive() { \n    if (this.gw == null) return null;\n    return await this.gw.receive(msg => {\n      if (msg.__clazz__ != DatagramNtf.__clazz__ && msg.__clazz__ != RxFrameNtf.__clazz__ ) return false;\n      let p = msg.protocol;\n      if (p == Protocol.DATA || p >= Protocol.USER) {\n        return this.localProtocol < 0 || this.localProtocol == p;\n      }\n      return false;\n    }, this.timeout);\n  }\n\n  /**\n   * Gets a Gateway to provide low-level access to UnetStack.\n   * @returns {Gateway} - underlying fjage Gateway supporting this socket\n   */\n  getGateway() { return this.gw; }\n\n  /**\n   * Gets an AgentID providing a specified service for low-level access to UnetStack\n   * @param {string} svc - the named service of interest\n   * @returns {Promise<?AgentID>} - a promise which returns an {@link AgentID} that provides the service when resolved\n   */\n  async agentForService(svc) {\n    if (this.gw == null) return null;\n    return await this.gw.agentForService(svc);\n  }\n\n  /**\n   * \n   * @param {string} svc - the named service of interest\n   * @returns {Promise<AgentID[]>} - a promise which returns an array of {@link AgentID|AgentIDs} that provides the service when resolved\n   */\n  async agentsForService(svc) {\n    if (this.gw == null) return null;\n    return await this.gw.agentsForService(svc);\n  }\n\n  /**\n   * Gets a named AgentID for low-level access to UnetStack.\n   * @param {string} name - name of agent\n   * @returns {AgentID} - AgentID for the given name\n   */\n  agent(name) {\n    if (this.gw == null) return null;\n    return this.gw.agent(name);\n  }\n\n  /**\n   * Resolve node name to node address.\n   * @param {string} nodeName - name of the node to resolve\n   * @returns {Promise<?number>} - address of the node, or null if unable to resolve\n   */\n  async host(nodeName) { \n    const arp = await this.agentForService(Services.ADDRESS_RESOLUTION);\n    if (arp == null) return null;\n    const req = new AddressResolutionReq(nodeName);\n    req.name = nodeName;\n    req.recipient = arp;\n    const rsp = await this.gw.request(req, REQUEST_TIMEOUT);\n    if (rsp == null || ! Object.prototype.hasOwnProperty.call(rsp, 'address')) return null;\n    return rsp.address;\n  }\n}"],"names":["isBrowser","window","document","isWebWorker","self","constructor","name","isNode","process","versions","node","SOCKET_OPEN","SOCKET_OPENING","createConnection","TCPconnector","[object Object]","opts","this","url","URL","host","hostname","port","_buf","pendingOnOpen","connListeners","_sockInit","val","forEach","l","toString","call","_sockSetup","import","then","module","error","debug","console","log","sock","setEncoding","on","_onSockOpen","bind","_sockReconnect","_sendConnEvent","send","data","write","_firstConn","keepAlive","readyState","_firstReConn","remoteAddress","remotePort","setTimeout","_reconnectTime","_processSockData","cb","length","s","lines","split","idx","_onSockRx","push","listener","ndx","indexOf","splice","onclose","destroy","WSConnector","pathname","reconnectTime","_keepAlive","_websockSetup","WebSocket","onerror","_websockReconnect","onopen","_onWebsockOpen","CONNECTING","OPEN","onmessage","event","_onWebsockRx","close","Performative","REQUEST","AGREE","REFUSE","FAILURE","INFORM","CONFIRM","DISCONFIRM","QUERY_IF","NOT_UNDERSTOOD","CFP","PROPOSE","CANCEL","AgentID","topic","owner","msg","recipient","toJSON","timeout","request","connector","params","values","index","ParameterReq","Array","isArray","requests","map","p","i","param","value","Number","isInteger","rsp","ret","fill","perf","rvals","Object","keys","f","find","rv","endsWith","Message","inReplyTo","msgID","sender","__clazz__","_guid","suffix","clazz","replace","k","startsWith","JSON","stringify","v","key","obj","String","parse","e","qclazz","MessageClass","_inflate","Gateway","gObj","location","warn","assign","GATEWAY_DEFAULTS","DEFAULT_URL","existing","_getGWCache","_timeout","_queueSize","queueSize","pending","subscriptions","eventListeners","queue","aid","_createConnector","_addGWCache","type","_sendEvent","_decodeBase64","id","action","_deserialize","message","consumed","shift","inResponseTo","agentIDs","getName","answer","agentID","services","undefined","_msgTx","rq","Promise","resolve","timer","clearTimeout","conn","protocol","setReadCallback","_onMsgRx","addConnectionListener","state","flush","_update_watch","filter","prototype","hasOwnProperty","__proto__","matchedMsg","_matchMessage","fjage","gateways","g","gw","addEventListener","removeEventListener","topic2","isTopic","service","_msgTxRx","aids","relay","_serialize","receive","_getMessageFromQueue","lid","_removeGWCache","Services","SHELL","parent","sname","cls","super","len","s4","Math","floor","random","substring","d","x","base64","dtype","littleEndian","atob","bytes","Uint8Array","charCodeAt","view","DataView","buffer","getUint8","getInt16","getInt32","getInt64","getFloat32","getFloat64","_b64toArray","navigator","userAgent","includes","global","a","Buffer","from","DatagramReq","DatagramNtf","BasebandSignal","NODE_INFO","ADDRESS_RESOLUTION","DATAGRAM","PHYSICAL","RANGING","BASEBAND","LINK","MAC","ROUTING","ROUTE_MAINTENANCE","TRANSPORT","REMOTE","STATE_MANAGER","Protocol","DATA","LINK2","USER","MAX","UnetMessages","TestReportNtf","AbnormalTerminationNtf","CapabilityListRsp","CapabilityReq","ClearReq","DatagramCancelReq","DatagramDeliveryNtf","DatagramFailureNtf","DatagramProgressNtf","ParamChangeNtf","RefuseRsp","FailureNtf","DatagramTraceReq","RouteDiscoveryReq","RouteTraceReq","RouteDiscoveryNtf","RouteTraceNtf","FecDecodeReq","RxJanusFrameNtf","TxJanusFrameReq","BadFrameNtf","BadRangeNtf","ClearSyncReq","CollisionNtf","RxFrameNtf","RxFrameStartNtf","SyncInfoReq","SyncInfoRsp","TxFrameNtf","TxFrameReq","TxFrameStartNtf","TxRawFrameReq","AddressAllocReq","AddressAllocRsp","AddressResolutionReq","AddressResolutionRsp","RecordBasebandSignalReq","RxBasebandSignalNtf","TxBasebandSignalReq","LinkStatusNtf","RangeNtf","RangeReq","BeaconReq","RespondReq","InterrogationNtf","ReservationAcceptReq","ReservationCancelReq","ReservationReq","ReservationRsp","ReservationStatusNtf","RxAckNtf","TxAckReq","RemoteExecReq","RemoteFailureNtf","RemoteFileGetReq","RemoteFileNtf","RemoteFilePutReq","RemoteSuccessNtf","RemoteTextNtf","RemoteTextReq","AddScheduledSleepReq","GetSleepScheduleReq","RemoveScheduledSleepReq","SleepScheduleRsp","WakeFromSleepNtf","ClearStateReq","SaveStateReq","path","localProtocol","remoteProtocol","provider","agentsForService","subscribe","to","nodeinfo","agentForService","addr","get","ms","req","svc","agent","nodeName","arp","address"],"mappings":"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"}